#!/usr/bin/env node

MODE = process.argv[2];
VERSION = process.argv[3];
var util            = require('util')
,   exec           = require('child_process').exec
,   shjs            = require('shelljs')
,   tempRepoDir    = 'temp/repositories'
,	oldVer          = process.argv[4];

var commandQueue = [],
    child1;

    
function queueCommand(cmd) {
    commandQueue.push(cmd);
}

function executeCommands(callback) {
    var cmd = commandQueue.shift();
    if (cmd) {
		child1 = shjs.exec(cmd, {async:true}, function(err, stdout, stderr) {
        	if (err !== 0) {
        		console.log('ERROR!' + err);
          		util.puts(stderr);
		  		executeCommands(callback);
        	} else {
          		executeCommands(callback);
        	}
		});
    	if (commandQueue.length === 0) {
    		// Attach the callback to the child since this is the last command.
    		child1.on('exit', callback);
   		}
    }
}

//check for git dependancy
if (!shjs.which('git')) {
  queueCommand('echo Sorry, this script requires git');
  exit(1);
}

//if phonegap directory already exisits, make sure it is latest code
if (shjs.test('-d','./phonegap')){
    queueCommand('echo phonegap directory exists');
    //queueCommand('cd phonegap && git pull origin master');
    
}else{
    //grab phonegap repo off github
    queueCommand("git clone https://github.com/phonegap/phonegap.git");
}

if (MODE==="prepare"||MODE==="all"){
    //run coho
    queueCommand("./node_modules/coho/coho build "+VERSION+" "+oldVer);
}

if (MODE==="build"||MODE==="all"){
    //ios
    queueCommand("rm -rf phonegap/lib/ios/*");
    queueCommand("cp -r temp/repositories/cordova-ios/* phonegap/lib/ios/");

    //android
    queueCommand("rm -rf phonegap/lib/android/*");
    queueCommand("cd temp/repositories/cordova-android && ./bin/create example");
    queueCommand("cp -r temp/repositories/cordova-android/* phonegap/lib/android/");
    queueCommand("rm -rf phonegap/lib/android/framework && rm -rf phonegap/lib/android/test");
    queueCommand("cp phonegap/lib/android/example/libs/cordova-"+VERSION+".jar phonegap/lib/android/");
    queueCommand("cp phonegap/lib/android/example/assets/www/cordova-"+VERSION+".js phonegap/lib/android/");
    queueCommand("cp -r phonegap/lib/android/example/res/xml phonegap/lib/android/");

    //blackberry
    queueCommand("rm -rf phonegap/lib/blackberry/*");
    queueCommand("cp -r temp/repositories/cordova-blackberry/* phonegap/lib/blackberry/")
    queueCommand("cd temp/repositories/cordova-blackberry && ./bin/create");
    queueCommand("cp -r temp/repositories/cordova-blackberry/example phonegap/lib/blackberry/");

    //windows phone 7
    queueCommand("rm -rf phonegap/lib/windows-phone-7/*");
    queueCommand("cp -r temp/repositories/cordova-wp7/* phonegap/lib/windows-phone-7/");
    
    //windows phone 8
    queueCommand("rm -rf phonegap/lib/windows-phone-8/*");
    queueCommand("cp -r temp/repositories/cordova-wp8/* phonegap/lib/windows-phone-8/");

    //windows 8
    queueCommand("rm -rf phonegap/lib/windows8/*");
    queueCommand("cp -r temp/repositories/cordova-windows/windows8/* phonegap/lib/windows8/");
    
    //webos
    queueCommand("rm -rf phonegap/lib/webos/*");
    queueCommand("cp -r temp/repositories/cordova-webos/* phonegap/lib/webos/");

    //bada
    queueCommand("rm -rf phonegap/lib/bada/*");
    queueCommand("cp -r temp/repositories/cordova-bada/* phonegap/lib/bada/");

    //badawac
    queueCommand("rm -rf phonegap/lib/badaWac/*");
    queueCommand("cp -r temp/repositories/cordova-bada-wac/* phonegap/lib/badaWac/");
    
    //cordova cli
    queueCommand("rm -rf phonegap/lib/cordova-cli/*");
    queueCommand("cp -r temp/repositories/cordova-cli/* phonegap/lib/cordova-cli/");

    //docs
    /*queueCommand("rm -rf phonegap/doc/*");
    queueCommand("cd temp/repositories/cordova-docs && ./bin/generate && cp -r public/en/"+VERSION+"/* ../../../phonegap/doc/");
    */
    //copy changelog
    queueCommand("cp -r temp/release/src/cordova-"+VERSION+"/changelog phonegap/");

    //copy update version file
    queueCommand("cp -r temp/repositories/cordova-android/VERSION phonegap/");
    
    //add phonegap variable to cordova.js files
    queueCommand("for file in $(find phonegap/ -name 'cordova-"+VERSION+".js'); do echo 'var PhoneGap = cordova;'>>$file; done;");
}

executeCommands(function(){
	shjs.exec("echo DONE", {async:true}, function(e, stdout, stderr) {
	});
});
